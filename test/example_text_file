Break apart the code
Each fragment can be tested
Then life is easy
